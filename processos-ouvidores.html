<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Processos Ouvidores</title>
  <script type="module" src="supabase.js"></script>
  <link rel="stylesheet" href="css/processos-ouvidores.css">
  <link rel="stylesheet" href="css/toast.css">
 
</head>
<body>
  <!-- Filtro -->
  <label for="filtroStatus"><strong>Filtrar por status:</strong></label>
  <select id="filtroStatus">
    <option value="todas">Todas</option>
    <option value="RESPONDIDO">Respondidas</option>
    <option value="AGUARDANDO RESPOSTA">Aguardando Resposta</option>
  </select>

  <div id="listaDemandas"></div>

  <!-- Modal -->
  <div class="modal-bg" id="modal-bg">
    <div class="modal">
      <button class="modal-close" id="modal-close">&times;</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    const lista = document.getElementById("listaDemandas");
    const modalBg = document.getElementById("modal-bg");
    const modalContent = document.getElementById("modal-content");
    const modalClose = document.getElementById("modal-close");
    const filtro = document.getElementById("filtroStatus");

    let demandasCache = [];

    // üîπ Obt√©m o nome do ouvidor logado
    const ouvidorLogado = JSON.parse(sessionStorage.getItem("usuario_ouvidor"));
    const nomeOuvidor = ouvidorLogado?.nome || "Ouvidor Municipal";

    const categoriaParaSetor = {
      "Sa√∫de": "Secretaria Municipal de Sa√∫de",
      "Educa√ß√£o": "Secretaria Municipal de Educa√ß√£o",
      "Transporte e Mobilidade": "Secretaria Municipal de Transporte e Tr√¢nsito",
      "Infraestrutura": "Secretaria de Obras e Infraestrutura",
      "Seguran√ßa": "Secretaria de Seguran√ßa ou Guarda Municipal",
      "Meio Ambiente": "Secretaria do Meio Ambiente",
      "Cultura e Lazer": "Secretaria de Cultura e Lazer",
      "Servi√ßos Urbanos": "Secretaria de Administra√ß√£o ou Protocolo"
    };

    const categorias = {
      "Sa√∫de": ["Atendimento m√©dico","Postos de sa√∫de","Vacina√ß√£o","Farm√°cia municipal"],
      "Educa√ß√£o": ["Escolas e creches","Transporte escolar","Material did√°tico","Programas educacionais"],
      "Transporte e Mobilidade": ["Transporte p√∫blico","Sem√°foros e sinaliza√ß√£o","Ruas e cal√ßadas","Ciclovias"],
      "Infraestrutura": ["Pavimenta√ß√£o de ruas","Ilumina√ß√£o p√∫blica","Limpeza urbana","Saneamento b√°sico"],
      "Seguran√ßa": ["Guarda municipal","Ilumina√ß√£o e seguran√ßa em locais p√∫blicos","Den√∫ncia de crimes e viol√™ncia"],
      "Meio Ambiente": ["√Åreas verdes","Coleta de lixo","Polui√ß√£o e res√≠duos","Animais abandonados"],
      "Cultura e Lazer": ["Eventos culturais","Espa√ßos de lazer e esportes","Bibliotecas e centros culturais"],
      "Servi√ßos Urbanos": ["Registro civil","IPTU e taxas municipais","Atendimento ao cidad√£o","Protocolo e documentos"],
      "Reclama√ß√µes Gerais": ["Outras situa√ß√µes n√£o enquadradas acima"]
    };

    const setores = Object.values(categoriaParaSetor);

    async function carregarDemandas() {
      const { data, error } = await supabase
        .from("demandas")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        lista.innerHTML = "<p>Erro ao carregar demandas.</p>";
        console.error(error);
        return;
      }

      demandasCache = data;
      exibirDemandas();
    }

    function exibirDemandas() {
      const filtroStatus = filtro.value;
      const demandasFiltradas = demandasCache.filter(d => 
        filtroStatus === "todas" ? true : d.status === filtroStatus
      );

      lista.innerHTML = "";

      demandasFiltradas.forEach(demanda => {
        const div = document.createElement("div");
        div.className = "processo";
        div.innerHTML = `
          ${demanda.categoria ? `<div class="info"><strong>Categoria:</strong> ${demanda.categoria}</div>` : ""}
          ${demanda.setor ? `<div class="info"><strong>Setor:</strong> ${demanda.setor}</div>` : ""}
          <div class="info"><strong>Prioridade na tramita√ß√£o:</strong> ${demanda.prioridade}</div>
          <div>
            <span class="status ${demanda.status === "RESPONDIDO" ? "respondido" : "aguardando"}">
              STATUS: ${demanda.status}
            </span>
            <button class="acessar-btn" data-id="${demanda.id}">Acessar</button>
          </div>
        `;
        lista.appendChild(div);
      });

      document.querySelectorAll(".acessar-btn").forEach(btn => {
        btn.addEventListener("click", () => abrirModal(btn.dataset.id));
      });
    }

    filtro.addEventListener("change", exibirDemandas);

    function abrirModal(id) {
      const demanda = demandasCache.find(d => d.id == id);

      let categoriaOptions = "";
      for (const grupo in categorias) {
        categoriaOptions += `<option class="categoria-principal" disabled>${grupo}</option>`;
        categorias[grupo].forEach(subcat => {
          const selected = demanda.categoria === subcat ? "selected" : "";
          categoriaOptions += `<option value="${subcat}" ${selected}>  ${subcat}</option>`;
        });
      }

      const setorOptions = setores.map(set => 
        `<option value="${set}" ${demanda.setor === set ? 'selected' : ''}>${set}</option>`
      ).join('');

      modalContent.innerHTML = `
        <div class="modal-title">${demanda.status}</div>

        <label>* Categoria da manifesta√ß√£o:</label><br>
        <select id="categoriaInput">${categoriaOptions}</select><br>

        <label>* Setor respons√°vel:</label><br>
        <select id="setorInput">${setorOptions}</select><br>

        <label>Manifesta√ß√£o:</label>
        <div class="manifestacao-box">
          ${demanda.manifestacao}
          <div class="assinatura">
            ${demanda.usuario_nome},<br>
            ${demanda.bairro},<br>
            ${new Date(demanda.created_at).toLocaleDateString("pt-BR")}
          </div>
        </div>

        <div class="prioridade-box">
          O solicitante <span>${demanda.prioridade === "SIM" ? "DESEJA" : "N√ÉO DESEJA"}</span> prioridade na tramita√ß√£o conforme a
          <a href="https://www.planalto.gov.br/ccivil_03/leis/l9784.htm" target="_blank">Lei Federal n¬∫ 9.784/1999</a>.
        </div>

        <label>Resposta da Ouvidoria:</label>
        <textarea id="respostaTexto" placeholder="Digite sua resposta de forma clara e objetiva...">${demanda.resposta || ""}</textarea>

        

        <button class="enviar-btn" onclick="enviarResposta(${demanda.id})">Salvar Atualiza√ß√µes</button>
      `;

      const categoriaSelect = document.getElementById("categoriaInput");
      const setorSelect = document.getElementById("setorInput");
      categoriaSelect.addEventListener("change", () => {
        const grupo = Object.keys(categorias).find(g => categorias[g].includes(categoriaSelect.value));
        setorSelect.value = categoriaParaSetor[grupo] || "";
      });

      modalBg.style.display = "flex";
    }

    // üîπ Envio da resposta com assinatura personalizada
    window.enviarResposta = async function(id) {
      const resposta = document.getElementById("respostaTexto").value.trim();
      const categoria = document.getElementById("categoriaInput").value;
      const setor = document.getElementById("setorInput").value;

      const { error } = await supabase
        .from("demandas")
        .update({ 
          status: resposta ? "RESPONDIDO" : "AGUARDANDO RESPOSTA",
          resposta: resposta ? `${resposta}\n\n<br>${nomeOuvidor},\n${new Date().toLocaleDateString("pt-BR")}` : "",
          categoria,
          setor
        })
        .eq("id", id);

      if (error) {
          showToast('Erro ao salvar altera√ß√µes.', 'error');
          console.error(error);
      } else {
          showToast('Atualiza√ß√µes salvas com sucesso!');
        modalBg.style.display = "none";
        carregarDemandas();
      }
    }

    modalClose.onclick = () => modalBg.style.display = "none";
    window.onclick = (e) => { if (e.target === modalBg) modalBg.style.display = "none"; };

    carregarDemandas();
  </script>
  <div id="toasts-container"></div>
  <script src="script/toast.js"></script>
</body>
</html>
