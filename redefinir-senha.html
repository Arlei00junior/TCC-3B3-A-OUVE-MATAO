<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Redefinir Senha</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/redefinir-senha.css">
    <link rel="stylesheet" href="css/global.css">
</head>

<body class="redefinir-page">
    <div class="container">
        <div class="left-side">
            <img src="img/logo-header.png" alt="Logo" class="logo">
        </div>
        <div class="right-side">
            <form class="redefinir-form" id="form-redefinir">
                <div class="form-heading">Redefinir Senha</div>

                <!-- PASSO 1: CPF -->
                <div class="form-step" id="step-cpf">
                    <div class="input-group">
                        <label for="cpf" class="label">CPF</label>
                        <input type="text" id="cpf" name="cpf" maxlength="14" placeholder="Digite seu CPF" required>
                    </div>
                    <button type="button" id="gerar-codigo" class="submit">Enviar C√≥digo</button>
                </div>

                <!-- PASSO 2: C√ìDIGO -->
                <div class="form-step" id="step-codigo" style="display: none;">
                    <div class="input-group">
                        <label for="codigo" class="label">C√≥digo de Verifica√ß√£o</label>
                        <input type="text" id="codigo" placeholder="Digite o c√≥digo enviado" required>
                    </div>
                    <button type="button" id="validar-codigo" class="submit">Validar C√≥digo</button>
                    <button type="button" id="reenviar-codigo" class="submit">Reenviar C√≥digo</button>
                    <p id="contador"></p>
                </div>

                <!-- PASSO 3: NOVA SENHA -->
                <div class="form-step" id="step-nova-senha" style="display: none;">
                    <div class="input-group">
                        <label for="nova-senha" class="label">Nova Senha</label>
                        <input type="password" id="nova-senha" placeholder="Digite a nova senha" required>
                    </div>
                    <div class="input-group">
                        <label for="confirmar-senha" class="label">Confirmar Nova Senha</label>
                        <input type="password" id="confirmar-senha" placeholder="Confirme a nova senha" required>
                    </div>
                    <button type="submit" class="submit">Redefinir Senha</button>
                </div>

                <div class="login-link">
                    <a href="login.html">Voltar para o Login</a>
                </div>
            </form>
        </div>
    </div>

    <!-- CONTATO -->
    <section id="contato">
        <div class="info">
            <h1>Contato</h1>
            <p>Rua Alegre, 123, Cidade Brasileira</p>
            <p>Tel: (12) 3456-7890</p>
            <p>ola@grandesite.com.br</p>
        </div>
        <div class="social">
            <div class="social-content">
                <h2>Siga a gente<br />nas redes sociais</h2>
                <div class="redes">
                    <a href="#"><img src="img/facebook.svg" alt="Facebook" /></a>
                    <a href="#"><img src="img/instagram.svg" alt="Instagram" /></a>
                    <a href="#"><img src="img/youtube.svg" alt="YouTube" /></a>
                </div>
                <img src="img/logo-header.png" alt="Ouve Mat√£o" class="logo-ouvidoria" />
            </div>
        </div>
    </section>

    <div id="pageTransitionLogo" class="page-transition-logo hide">
        <img src="img/logo-header.png" alt="Logo Ouve Mat√£o" />
    </div>

    <script type="module">
        import { supabase } from './supabase.js';

        const stepCpf = document.getElementById('step-cpf');
        const stepCodigo = document.getElementById('step-codigo');
        const stepNovaSenha = document.getElementById('step-nova-senha');

        const gerarCodigoBtn = document.getElementById('gerar-codigo');
        const validarCodigoBtn = document.getElementById('validar-codigo');
        const reenviarCodigoBtn = document.getElementById('reenviar-codigo');

        const cpfInput = document.getElementById('cpf');
        const codigoInput = document.getElementById('codigo');
        const novaSenhaInput = document.getElementById('nova-senha');
        const confirmarSenhaInput = document.getElementById('confirmar-senha');
        const contadorP = document.getElementById('contador');

        let resetToken = null;
        let resetExpira = null;
        let usuarioEmail = null;
        let timerInterval = null;

        function iniciarContagem(expira) {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const agora = new Date().getTime();
                const distancia = expira - agora;
                if (distancia <= 0) {
                    clearInterval(timerInterval);
                    contadorP.textContent = "‚è∞ C√≥digo expirado!";
                    return;
                }
                const minutos = Math.floor((distancia % (1000 * 60 * 60)) / (1000 * 60));
                const segundos = Math.floor((distancia % (1000 * 60)) / 1000);
                contadorP.textContent = `‚è≥ C√≥digo expira em ${minutos}m ${segundos}s`;
            }, 1000);
        }

        async function enviarCodigo(email) {
            resetToken = Math.floor(100000 + Math.random() * 900000);
            resetExpira = new Date().getTime() + (15 * 60 * 1000);

            localStorage.setItem('resetToken', resetToken);
            localStorage.setItem('resetExpira', resetExpira);

            const resp = await fetch('https://fvrbxhvveogjsunnoryu.supabase.co/functions/v1/send-reset-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, token: resetToken })
            });

            const resultado = await resp.json();
            return resultado.success;
        }

        gerarCodigoBtn.addEventListener('click', async () => {
            const cpf = cpfInput.value.trim();
            if (!cpf) return alert("‚ö†Ô∏è Preencha seu CPF!");

            const cpfFormatado = cpf.replace(/\D/g, ''); // remove pontos e tra√ßos

            try {
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('email')
                    .eq('cpf', cpfFormatado)
                    .single();

                if (error) throw error;
                if (!data) return alert("‚ùå CPF n√£o encontrado!");

                usuarioEmail = data.email;

                const enviado = await enviarCodigo(usuarioEmail);
                if (enviado) {
                    stepCpf.style.display = 'none';
                    stepCodigo.style.display = 'block';
                    iniciarContagem(resetExpira);
                    alert("üì© C√≥digo enviado para seu e-mail!");
                } else {
                    alert("‚ùå Erro ao enviar c√≥digo!");
                }

            } catch (err) {
                console.error(err);
                alert("‚ùå Erro ao consultar usu√°rio. Verifique a tabela 'usuarios' e a pol√≠tica de RLS.");
            }
        });

        reenviarCodigoBtn.addEventListener('click', async () => {
            if (!usuarioEmail) return alert("‚ö†Ô∏è Nenhum usu√°rio carregado!");
            const enviado = await enviarCodigo(usuarioEmail);
            if (enviado) {
                alert("üì© Novo c√≥digo enviado!");
            } else {
                alert("‚ùå Erro ao reenviar c√≥digo!");
            }
        });

        validarCodigoBtn.addEventListener('click', () => {
            const codigo = codigoInput.value.trim();
            const token = localStorage.getItem('resetToken');
            const expira = localStorage.getItem('resetExpira');

            if (!codigo) return alert("‚ö†Ô∏è Digite o c√≥digo enviado!");
            if (parseInt(codigo) !== parseInt(token)) return alert("‚ùå C√≥digo inv√°lido!");
            if (new Date().getTime() > parseInt(expira)) return alert("‚è∞ C√≥digo expirado!");

            stepCodigo.style.display = 'none';
            stepNovaSenha.style.display = 'block';
        });

        document.getElementById('form-redefinir').addEventListener('submit', async (e) => {
            e.preventDefault();
            const novaSenha = novaSenhaInput.value.trim();
            const confirmarSenha = confirmarSenhaInput.value.trim();

            if (!novaSenha || !confirmarSenha) return alert("‚ö†Ô∏è Preencha todas as senhas!");
            if (novaSenha !== confirmarSenha) return alert("‚ùå Senhas n√£o conferem!");

            const { data, error } = await supabase
                .from('usuarios')
                .update({ senha: novaSenha })
                .eq('email', usuarioEmail);

            if (error) {
                alert("‚ùå Erro ao atualizar senha!");
            } else {
                alert("‚úÖ Senha redefinida com sucesso!");
                window.location.href = "login.html";
            }
        });
    </script>
</body>
</html>
