<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/login.css">
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/toast.css">
  <title>Login - Ouve Mat칚o</title>
</head>

<body class="login-page">
  <div vw class="enabled">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper>
      <div class="vw-plugin-top-wrapper"></div>
    </div>
  </div>
  <script src="script/vlibras.js"></script>
  <script>
    new window.VLibras.Widget('https://vlibras.gov.br/app');
  </script>
  
  <div class="container">
    <!-- Esquerda: Logo e textos -->
    <div class="left-side">
      <img src="img/logo-header.png" alt="Ouve Mat칚o" class="logo">
      <div class="links">
        <a href="termos.html">TERMOS E POL칈TICAS</a>
        <a href="sobre.html">SOBRE N칍S</a>
      </div>
    </div>
     <!-- Bot칚o flutuante de acessibilidade -->
    <button id="btnAcessibilidade" title="Ativar leitura de tela">
      游댉
    </button>

    <script src="acessibilidade.js"></script>

    <!-- Direita: Caixa de login -->
    <div class="right-side">
      <form id="login-form" class="login-form">
        <div class="form-heading">Login</div>
        <div class="input-group">
          <input required placeholder="Digite o CPF cadastrado" name="cpf" id="cpf" type="text" />
          <label class="label" for="cpf">Usu치rio</label>
        </div>
        <div class="input-group">
          <input required placeholder="Digite sua senha definida" name="password" id="password" type="password" />
          <label class="label" for="password">Senha</label>

        </div>

        <button class="submit" type="submit">Acessar</button>
        <div class="signup-link">
          N칚o tem cadastro? <a href="cadastro.html">Clique aqui</a><br />
          칄 ouvidor? <a href="login-ouvidores.html">Clique aqui</a>
        </div>
      </form>
    </div>
  </div>

  <!-- CONTATO -->
  <section id="contato">
    <div class="info">
      <h1>Contato</h1>
      <p>Rua Alegre, 123, Cidade Brasileira</p>
      <p>Tel: (12) 3456-7890</p>
      <p>ola@grandesite.com.br</p>
    </div>
    <div class="social">
      <div class="social-content">
        <h2>Siga a gente<br />nas redes sociais</h2>
        <div class="redes">
          <a href="#"><img src="img/facebook.svg" alt="Facebook" /></a>
          <a href="#"><img src="img/instagram.svg" alt="Instagram" /></a>
          <a href="principal.html"><img src="img/youtube.svg" alt="YouTube" /></a>
        </div>
        <img src="img/logo-header.png" alt="Ouve Mat칚o" class="logo-ouvidoria" />
      </div>
    </div>
  </section>
  <!-- Toast container -->
  <div id="toasts-container"></div>

  <!-- Toast script -->
  <script src="script/toast.js"></script>

  <!-- Script de login com m치scara de CPF -->
  <script type="module">
    import { supabase } from './supabase.js';
    /*
      Script de login (p치gina login.html)
      - M치scara de CPF: formata enquanto o usu치rio digita
      - Redirecionamento autom치tico se j치 estiver logado
      - Submiss칚o do formul치rio: consulta Supabase (tabela 'usuarios') e salva sessionStorage em caso de sucesso
      - Tratamento de erros com showToast
    */

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('login-form');
      const cpfInput = document.getElementById('cpf');

      // Verifica exist칡ncia do form
      if (!form) {
        console.error("Formul치rio n칚o encontrado!");
        return;
      }

      // M치scara suave de CPF (formata칞칚o local de exibi칞칚o)
      cpfInput.addEventListener('input', function () {
        let value = cpfInput.value.replace(/\D/g, ''); // remove tudo que n칚o 칠 n칰mero
        if (value.length > 11) value = value.slice(0, 11);

        if (value.length > 9) {
          value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
        } else if (value.length > 6) {
          value = value.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else if (value.length > 3) {
          value = value.replace(/(\d{3})(\d{0,3})/, '$1.$2');
        }
        cpfInput.value = value;
      });

      // Se j치 estiver logado como popula칞칚o, redireciona automaticamente (n칚o altera DB)
      const usuarioLogado = JSON.parse(sessionStorage.getItem('usuario_populacao'));
      if (usuarioLogado && usuarioLogado.tipo_usuario === 'populacao') {
        window.location.href = 'principal.html';
        return;
      }

      // Evento de submit do formul치rio
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const cpf = cpfInput.value.trim();
        const senha = document.getElementById('password').value.trim();

        try {
          // Consulta 칰nica ao Supabase
          const { data, error } = await supabase
            .from('usuarios')
            .select('*')
            .eq('cpf', cpf)
            .eq('senha', senha)
            .eq('tipo_usuario', 'populacao')
            .single();

          if (error || !data) {
            // Mensagem de erro ao usu치rio (visual)
            showToast('CPF ou senha inv치lidos!', 'error');
            return;
          }

          // Salva apenas durante a sess칚o do navegador (sessionStorage)
          sessionStorage.setItem('usuario_populacao', JSON.stringify(data));

          // Feedback de sucesso e redirecionamento curto para principal.html
          showToast('Login realizado com sucesso!');
          setTimeout(() => window.location.href = 'principal.html', 800);

        } catch (err) {
          console.error("Erro inesperado:", err);
          showToast('Ocorreu um erro no login!', 'error');
        }
      });
    });

    /*
      Fun칞칚o utilit치ria: adiciona 칤cone de olho para mostrar/ocultar senha
      - Recebe um input de senha
      - N칚o altera dados, apenas comportamento visual
    */
    (function () {
      function addEyeIcon(input) {
        if (!input) return;
        const wrapper = input.parentElement;
        wrapper.style.position = 'relative';
        const eye = document.createElement('img');
        eye.src = 'img/olho-fechado.png';
        eye.alt = 'Mostrar senha';
        Object.assign(eye.style, {
          position: 'absolute',
          right: '10px',
          top: '50%',
          transform: 'translateY(-50%)',
          cursor: 'pointer',
          width: '24px',
          height: '24px'
        });
        eye.addEventListener('click', () => {
          input.type = input.type === 'password' ? 'text' : 'password';
          eye.src = input.type === 'password' ? 'img/olho-fechado.png' : 'img/olho-aberto.png';
        });
        wrapper.appendChild(eye);
      }

      document.addEventListener('DOMContentLoaded', () => {
        addEyeIcon(document.getElementById('password'));
        addEyeIcon(document.getElementById('confirmPassword'));
      });
    })();
  </script>
</body>

</html>