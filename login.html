<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/login.css">
  <link rel="stylesheet" href="css/global.css">
  <title>Login - Ouve Mat√£o</title>
</head>

<body class="login-page">
  <div class="container">
    <!-- Esquerda: Logo e textos -->
    <div class="left-side">
      <img src="img/logo-header.png" alt="Ouve Mat√£o" class="logo">
      <div class="links">
        <a href="termos.html">TERMOS E POL√çTICAS</a>
        <a href="sobre.html">SOBRE N√ìS</a>
      </div>
    </div>

    <!-- Direita: Caixa de login -->
    <div class="right-side">
      <form id="login-form" class="login-form">
        <div class="form-heading">Login</div>
        <div class="input-group">
          <input required placeholder="Digite o CPF cadastrado" name="cpf" id="cpf" type="text" />
          <label class="label" for="cpf">Usu√°rio</label>
        </div>
        <div class="input-group">
          <input required placeholder="Digite sua senha definida" name="password" id="password" type="password" />
            <label class="label" for="password">Senha</label>
            
        </div>
        
        <button class="submit" type="submit">Acessar</button>
        <div class="signup-link">
          N√£o tem cadastro? <a href="cadastro.html">Clique aqui</a><br />
          √â ouvidor? <a href="login-ouvidores.html">Clique aqui</a>
        </div>
      </form>
    </div>
  </div>

  <!-- CONTATO -->
  <section id="contato">
    <div class="info">
      <h1>Contato</h1>
      <p>Rua Alegre, 123, Cidade Brasileira</p>
      <p>Tel: (12) 3456-7890</p>
      <p>ola@grandesite.com.br</p>
    </div>
    <div class="social">
      <div class="social-content">
        <h2>Siga a gente<br />nas redes sociais</h2>
        <div class="redes">
          <a href="#"><img src="img/facebook.svg" alt="Facebook" /></a>
          <a href="#"><img src="img/instagram.svg" alt="Instagram" /></a>
          <a href="principal.html"><img src="img/youtube.svg" alt="YouTube" /></a>
        </div>
        <img src="img/logo-header.png" alt="Ouve Mat√£o" class="logo-ouvidoria" />
      </div>
    </div>
  </section>

  <!-- Script de login com m√°scara de CPF -->
  <script type="module">
    import { supabase } from './supabase.js';

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('login-form');
      const cpfInput = document.getElementById('cpf');

      if (!form) {
        console.error("Formul√°rio n√£o encontrado!");
        return;
      }

      // üîπ M√°scara suave de CPF
      cpfInput.addEventListener('input', function () {
        let value = cpfInput.value.replace(/\D/g, ''); // remove tudo que n√£o √© n√∫mero
        if (value.length > 11) value = value.slice(0, 11);

        if (value.length > 9) {
          value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
        } else if (value.length > 6) {
          value = value.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
        } else if (value.length > 3) {
          value = value.replace(/(\d{3})(\d{0,3})/, '$1.$2');
        }
        cpfInput.value = value;
      });

      // üîπ Se j√° estiver logado como popula√ß√£o, redireciona
      const usuarioLogado = JSON.parse(sessionStorage.getItem('usuario_populacao'));
      if (usuarioLogado && usuarioLogado.tipo_usuario === 'populacao') {
        window.location.href = 'principal.html';
        return;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const cpf = cpfInput.value.trim();
        const senha = document.getElementById('password').value.trim();

        try {
          const { data, error } = await supabase
            .from('usuarios')
            .select('*')
            .eq('cpf', cpf)
            .eq('senha', senha)
            .eq('tipo_usuario', 'populacao')
            .single();

          if (error || !data) {
            alert("‚ùå CPF ou senha inv√°lidos!");
            return;
          }

          // üîπ Salva apenas durante a sess√£o do navegador
          sessionStorage.setItem('usuario_populacao', JSON.stringify(data));

          alert("‚úÖ Login realizado com sucesso!");
          window.location.href = "principal.html";

        } catch (err) {
          console.error("Erro inesperado:", err);
          alert("‚ùå Ocorreu um erro no login!");
        }
      });
    });

     (function () {
              function addEyeIcon(input) {
              if (!input) return;
              const wrapper = input.parentElement;
              wrapper.style.position = 'relative';
              const eye = document.createElement('img');
              eye.src = 'img/olho-fechado.png';
              eye.alt = 'Mostrar senha';
              Object.assign(eye.style, {
                position: 'absolute',
                right: '10px',
                top: '50%',
                transform: 'translateY(-50%)',
                cursor: 'pointer',
                width: '24px',
                height: '24px'
              });
              eye.addEventListener('click', () => {
                input.type = input.type === 'password' ? 'text' : 'password';
                eye.src = input.type === 'password' ? 'img/olho-fechado.png' : 'img/olho-aberto.png';
              });
              wrapper.appendChild(eye);
              }

              document.addEventListener('DOMContentLoaded', () => {
              addEyeIcon(document.getElementById('password'));
              addEyeIcon(document.getElementById('confirmPassword'));
              });
            })();
  </script>
</body>
</html>
